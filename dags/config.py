from pathlib import Path

# ────────────────────────────────────────────────────────────────────────────
# 상수
# ────────────────────────────────────────────────────────────────────────────
KOSPI_RAW_DIR = Path("/opt/airflow/data/KOSPI/unzip")
KOSPI_PARTITION_DIR = Path("/opt/airflow/data/KOSPI/partitioned")
KOSPI_OUT_DIR = Path("/opt/airflow/data/KOSPI/ohlcv")


KOSDAQ_RAW_DIR = Path("/opt/airflow/data/KOSDAQ/unzip")
KOSDAQ_PARTITION_DIR = Path("/opt/airflow/data/KOSDAQ/partitioned")
KOSDAQ_OUT_DIR = Path("/opt/airflow/data/KOSDAQ/ohlcv")
TZ = "Asia/Seoul"

COLS = [
    "일자",
    "대량매매구분코드",
    "정규시간외구분코드",
    "종목코드",
    "종목인덱스",
    "체결번호",
    "체결가격",
    "체결수량",
    "체결유형코드",
    "체결일자",
    "체결시각",
    "근월물체결가격",
    "원월물체결가격",
    "매수회원번호",
    "매수호가유형코드",
    "매수자사주신고서ID",
    "매수자사주매매방법코드",
    "매수매도유형코드",
    "매수위탁자기구분코드",
    "매수위탁사번호",
    "매수PT구분코드",
    "매수투자자구분코드",
    "매수외국인투자자구분코드",
    "매수호가접수번호",
    "매도회원번호",
    "매도호가유형코드",
    "매도자사주신고서ID",
    "매도자사주매매방법코드",
    "매도매도유형코드",
    "매도위탁자기구분코드",
    "매도위탁사번호",
    "매도PT구분코드",
    "매도투자자구분코드",
    "매도외국인투자자구분코드",
    "매도호가접수번호",
    "시가",
    "고가",
    "저가",
    "직전가격",
    "누적체결수량",
    "누적거래대금",
    "최종매도매수구분코드",
    "LP보유수량",
    "데이터구분",
    "메세지일련번호",
    "매수프로그램호가신고구분코드",
    "매도프로그램호가신고구분코드",
    "보드ID",
    "세션ID",
    "실시간상한가",
    "실시간하한가",
]

KEEP = ["종목코드", "체결가격", "체결수량", "체결일자", "체결시각"]

keywords = {
    # 임상 관련 키워드를 먼저 배치하여 우선 매칭되도록 함
    "임상 계획 철회": [
        r"(?:임상|시험).*?(?:자진[\s·ㆍ\-]*취하|취하|철회|중단|반려|보류)",
        r"임상.*?(?:자진[\s·ㆍ\-]*취하|취하|철회|중단|반려|보류)",
        r"임상.*?중단",
    ],
    "임상 계획 신청": [
        r"(?:임상|시험).*?계획.*?(?:신청|제출)",
        r"(?:임상|시험).*?(?:IND|CTN).*?(?:신청|제출)",
        r"(?:임상|시험).*?(?:1상|2상|3상|1/2상|2/3상|1/2a상|2b상|2b/3상).*?(?:신청|제출)",
        r"(?:임상|시험).*?(?:제\d+상|제\s*\d+/\d+\w*상).*?(?:신청|제출)",
        r"임상.*?(?:신청|제출)",
        r"임상.*?계획.*?(?:IND|CTN).*?(?:신청|제출)",
        r"임상.*?(?:IND|CTN).*?(?:신청|제출)",
        r"가교임상시험.*?(?:신청|제출)",
        r"임상.*?개발.*?(?:신청|제출)",
    ],
    "임상 계획 승인": [
        r"(?:임상|시험).*?계획.*?(?:승인|완료)",
        r"(?:임상|시험).*?(?:IND|CTN).*?(?:승인|완료)",
        r"(?:임상|시험).*?(?:1상|2상|3상|1/2상|2/3상|1/2a상|2b상|2b/3상).*?(?:승인|완료)",
        r"(?:임상|시험).*?(?:제\d+상|제\s*\d+/\d+\w*상).*?(?:승인|완료)",
        r"(?:FDA|식약처|식품의약품안전처).*?(?:승인|완료)",
        r"임상.*?(?:승인|완료)",
        r"임상.*?계획.*?(?:IND|CTN).*?(?:승인|완료)",
        r"임상.*?(?:IND|CTN).*?(?:승인|완료)",
        r"임상.*?시험계획.*?(?:승인|완료)",
        r"임상.*?시험.*?계획.*?(?:승인|완료)",
        r"임상.*?시험.*?(?:승인|완료)",
        r"가교임상시험.*?(?:승인|완료)",
        r"일본임상.*?(?:승인|완료)",
        r"임상.*?중인.*?(?:승인|완료)",
    ],
    "임상 계획 결과 발표": [
        r"(?:임상|시험).*?(?:결과|data|종료)",
        r"(?:탑라인|topline).*?(?:결과|data)",
        r"(?:중간|interim).*?(?:결과|data)",
        r"(?:임상|시험).*?(?:완료|종료|진행[\s·ㆍ\-]*현황)",
        r"임상.*?(?:결과|data|종료)",
    ],
    "자산양수도(기타), 풋백옵션": [
        r"자산[\s·ㆍ\-]*양수도",
        r"풋[\s·ㆍ\-]*백[\s·ㆍ\-]*옵션",
    ],
    "부도발생": [r"부도[\s·ㆍ\-]*발생"],
    "영업정지": [r"영업[\s·ㆍ\-]*정지"],
    "회생절차 개시신청": [r"회생[\s·ㆍ\-]*절차[\s·ㆍ\-]*개시[\s·ㆍ\-]*신청"],
    "해산사유 발생": [
        r"해산[\s·ㆍ\-]*사유[\s·ㆍ\-]*발생(?:[^)]*)?",
        r"출자[\s·ㆍ\-]*법인[\s·ㆍ\-]*의?[\s·ㆍ\-]*해산[\s·ㆍ\-]*사유[\s·ㆍ\-]*발생(?:[^)]*)?",
        r"출자[\s·ㆍ\-]*법인[\s·ㆍ\-]*부도[\s·ㆍ\-]*ㆍ?해산[\s·ㆍ\-]*사유[\s·ㆍ\-]*등[\s·ㆍ\-]*발생",
    ],
    "유상증자 결정": [
        r"유상[\s·ㆍ\-]*증자[\s·ㆍ\-]*결정(?:[^)]*)?",
        r"유상[\s·ㆍ\-]*증자[\s·ㆍ\-]*결정\([\s\S]*?제3자[\s·ㆍ\-]*배정[\s\S]*?\)",
        r"유상[\s·ㆍ\-]*증자[\s·ㆍ\-]*결정\([\s\S]*?주주[\s·ㆍ\-]*배정[\s·ㆍ\-]*후[\s·ㆍ\-]*실권주[\s·ㆍ\-]*일반공모[\s\S]*?\)",
    ],
    "무상증자 결정": [r"무상[\s·ㆍ\-]*증자[\s·ㆍ\-]*결정(?:[^)]*)?"],
    "유무상증자 결정": [r"유무상[\s·ㆍ\-]*증자[\s·ㆍ\-]*결정"],
    "감자 결정": [
        r"감자[\s·ㆍ\-]*결정(?:[^)]*)?",
        r"감자[\s·ㆍ\-]*결정\([\s\S]*?무상[\s\S]*?\)",
        r"감자[\s·ㆍ\-]*결정\([\s\S]*?유상[\s\S]*?\)",
    ],
    "채권은행 등의 관리절차 개시": [
        r"채권[\s·ㆍ\-]*은행[\s·ㆍ\-]*등의?[\s·ㆍ\-]*관리[\s·ㆍ\-]*절차[\s·ㆍ\-]*개시"
    ],
    "소송 등의 제기": [
        r"소송[\s·ㆍ\-]*등의?[\s·ㆍ\-]*제기(?:[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*신청)?(?:[^)]*)?",
        r"소송[\s·ㆍ\-]*등의?[\s·ㆍ\-]*제기[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*신청\([\s\S]*?경영권[\s·ㆍ\-]*분쟁[\s\S]*?\)",
        r"소송[\s·ㆍ\-]*등의?[\s·ㆍ\-]*제기[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*신청\([\s\S]*?종속회사[\s\S]*?\)",
    ],
    "해외 증권시장 주권등 상장 결정": [
        r"해외[\s·ㆍ\-]*증권[\s·ㆍ\-]*시장[\s·ㆍ\-]*주권[\s·ㆍ\-]*등[\s·ㆍ\-]*상장[\s·ㆍ\-]*결정"
    ],
    "해외 증권시장 주권등 상장폐지 결정": [
        r"해외[\s·ㆍ\-]*증권[\s·ㆍ\-]*시장[\s·ㆍ\-]*주권[\s·ㆍ\-]*등[\s·ㆍ\-]*상장[\s·ㆍ\-]*폐지[\s·ㆍ\-]*결정"
    ],
    "해외 증권시장 주권등 상장": [
        r"해외[\s·ㆍ\-]*증권[\s·ㆍ\-]*시장[\s·ㆍ\-]*주권[\s·ㆍ\-]*등[\s·ㆍ\-]*상장(?![\s·ㆍ\-]*폐지)"
    ],
    "해외 증권시장 주권등 상장폐지": [
        r"해외[\s·ㆍ\-]*증권[\s·ㆍ\-]*시장[\s·ㆍ\-]*주권[\s·ㆍ\-]*등[\s·ㆍ\-]*상장[\s·ㆍ\-]*폐지(?![\s·ㆍ\-]*결정)"
    ],
    "전환사채권 발행결정": [r"전환[\s·ㆍ\-]*사채권[\s·ㆍ\-]*발행[\s·ㆍ\-]*결정"],
    "신주인수권부사채권 발행결정": [
        r"신주[\s·ㆍ\-]*인수권부[\s·ㆍ\-]*사채권[\s·ㆍ\-]*발행[\s·ㆍ\-]*결정"
    ],
    "교환사채권 발행결정": [r"교환[\s·ㆍ\-]*사채권[\s·ㆍ\-]*발행[\s·ㆍ\-]*결정"],
    "채권은행 등의 관리절차 중단": [
        r"채권[\s·ㆍ\-]*은행[\s·ㆍ\-]*등의?[\s·ㆍ\-]*관리[\s·ㆍ\-]*절차[\s·ㆍ\-]*중단"
    ],
    "상각형 조건부자본증권 발행결정": [
        r"상각형[\s·ㆍ\-]*조건부[\s·ㆍ\-]*자본[\s·ㆍ\-]*증권[\s·ㆍ\-]*발행[\s·ㆍ\-]*결정"
    ],
    "자기주식 취득 결정": [r"자기[\s·ㆍ\-]*주식[\s·ㆍ\-]*취득[\s·ㆍ\-]*결정"],
    "자기주식 처분 결정": [r"자기[\s·ㆍ\-]*주식[\s·ㆍ\-]*처분[\s·ㆍ\-]*결정"],
    "자기주식 소각 결정": [r"주식[\s·ㆍ\-]*소각[\s·ㆍ\-]*결정"],
    "자기주식취득 신탁계약 체결 결정": [
        r"자기[\s·ㆍ\-]*주식[\s·ㆍ\-]*취득[\s·ㆍ\-]*신탁[\s·ㆍ\-]*계약[\s·ㆍ\-]*체결[\s·ㆍ\-]*결정"
    ],
    "자기주식취득 신탁계약 해지 결정": [
        r"자기[\s·ㆍ\-]*주식[\s·ㆍ\-]*취득[\s·ㆍ\-]*신탁[\s·ㆍ\-]*계약[\s·ㆍ\-]*해지[\s·ㆍ\-]*결정"
    ],
    "영업양수 결정": [r"영업[\s·ㆍ\-]*양수[\s·ㆍ\-]*결정"],
    "영업양도 결정": [r"영업[\s·ㆍ\-]*양도[\s·ㆍ\-]*결정"],
    "유형자산 양수 결정": [
        r"유형[\s·ㆍ\-]*자산[\s·ㆍ\-]*취득[\s·ㆍ\-]*결정(?:[^)]*)?",
        r"유형[\s·ㆍ\-]*자산[\s·ㆍ\-]*양수[\s·ㆍ\-]*결정",
    ],
    "유형자산 양도 결정": [
        r"유형[\s·ㆍ\-]*자산[\s·ㆍ\-]*처분[\s·ㆍ\-]*결정(?:[^)]*)?",
        r"유형[\s·ㆍ\-]*자산[\s·ㆍ\-]*양도[\s·ㆍ\-]*결정",
    ],
    "타법인 주식 및 출자증권 양수결정": [
        r"타[\s·ㆍ\-]*법인[\s·ㆍ\-]*주식[\s·ㆍ\-]*및[\s·ㆍ\-]*출자[\s·ㆍ\-]*증권[\s·ㆍ\-]*(?:취득|양수)[\s·ㆍ\-]*결정(?:[^)]*)?"
    ],
    "타법인 주식 및 출자증권 양도결정": [
        r"타[\s·ㆍ\-]*법인[\s·ㆍ\-]*주식[\s·ㆍ\-]*및[\s·ㆍ\-]*출자[\s·ㆍ\-]*증권[\s·ㆍ\-]*(?:처분|양도)[\s·ㆍ\-]*결정(?:[^)]*)?"
    ],
    "주권 관련 사채권 양수 결정": [
        r"주권[\s·ㆍ\-]*관련[\s·ㆍ\-]*사채권[\s·ㆍ\-]*(?:의)?[\s·ㆍ\-]*취득[\s·ㆍ\-]*결정",
        r"주권[\s·ㆍ\-]*관련[\s·ㆍ\-]*사채권[\s·ㆍ\-]*양수[\s·ㆍ\-]*결정",
    ],
    "주권 관련 사채권 양도 결정": [
        r"주권[\s·ㆍ\-]*관련[\s·ㆍ\-]*사채권[\s·ㆍ\-]*(?:의)?[\s·ㆍ\-]*처분[\s·ㆍ\-]*결정",
        r"주권[\s·ㆍ\-]*관련[\s·ㆍ\-]*사채권[\s·ㆍ\-]*양도[\s·ㆍ\-]*결정",
    ],
    "회사합병 결정": [r"(?:회사)?[\s·ㆍ\-]*합병[\s·ㆍ\-]*결정"],
    "회사분할 결정": [
        r"(?:회사)?[\s·ㆍ\-]*분할[\s·ㆍ\-]*결정",
    ],
    "회사분할합병 결정": [r"(?:회사)?[\s·ㆍ\-]*분할[\s·ㆍ\-]*합병[\s·ㆍ\-]*결정"],
    "주식교환ㆍ이전 결정": [
        r"주식[\s·ㆍ\-]*교환[\s·ㆍ\-]*ㆍ[\s·ㆍ\-]*이전[\s·ㆍ\-]*결정",
    ],
    "지분공시": [
        r"임원[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*주요[\s·ㆍ\-]*주주[\s·ㆍ\-]*특정[\s·ㆍ\-]*증권[\s·ㆍ\-]*등[\s·ㆍ\-]*소유[\s·ㆍ\-]*상황[\s·ㆍ\-]*보고서",
        r"주식[\s·ㆍ\-]*등의?[\s·ㆍ\-]*대량[\s·ㆍ\-]*보유[\s·ㆍ\-]*상황[\s·ㆍ\-]*보고서",
        r"최대[\s·ㆍ\-]*주주[\s·ㆍ\-]*등?[\s·ㆍ\-]*소유[\s·ㆍ\-]*주식[\s·ㆍ\-]*변동[\s·ㆍ\-]*신고서",
        r"최대[\s·ㆍ\-]*주주[\s·ㆍ\-]*변경",
    ],
    "실적공시": [
        r"분기[\s·ㆍ\-]*보고서",
        r"반기[\s·ㆍ\-]*보고서",
        r"사업[\s·ㆍ\-]*보고서",
        r"연결[\s·ㆍ\-]*재무제표[\s·ㆍ\-]*기준[\s·ㆍ\-]*영업[\s·ㆍ\-]*(?:잠정)?[\s·ㆍ\-]*실적[\s·ㆍ\-]*\(공정공시\)",
    ],
    "단일판매ㆍ공급계약해지": [
        r"단일[\s·ㆍ\-]*판매[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*공급[\s·ㆍ\-]*계약[\s·ㆍ\-]*해지(?:[^)]*)?"
    ],
    "단일판매ㆍ공급계약체결": [
        r"단일[\s·ㆍ\-]*판매[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*공급[\s·ㆍ\-]*계약[\s·ㆍ\-]*체결(?:[^)]*)?"
    ],
    "생산중단": ["생산중단"],
    "배당": [r"현금[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*현물[\s·ㆍ\-]*배당[\s·ㆍ\-]*결정"],
    "매출액변동": [
        r"매출액(?:[\s·ㆍ\-]*또는[\s·ㆍ\-]*손익구조)?[\s·ㆍ\-]*30%\s*\(?(?:대규모법인은\s*15%)?\)?[\s·ㆍ\-]*이상[\s·ㆍ\-]*(?:변동|변경)(?:[^)]*)?"
    ],
    "소송등의판결ㆍ결정": [
        r"소송[\s·ㆍ\-]*등의?[\s·ㆍ\-]*판결[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*결정(?:[^)]*)?"
    ],
    "특허권취득": [r"특허권[\s·ㆍ\-]*취득"],
    "신규시설투자": [r"신규[\s·ㆍ\-]*시설[\s·ㆍ\-]*투자"],
    "기술이전계약해지": [r"기술[\s·ㆍ\-]*이전[^)\n]*해지"],
    "기술이전계약체결": [r"기술[\s·ㆍ\-]*이전[^)\n]*(?:계약[\s·ㆍ\-]*체결|체결)"],
    # --- 품목허가 계열 ---
    "품목허가 철회": [
        r"품목[\s·ㆍ\-]*허가[^)\n]*취소",  # 취소/취소처분/취소 통지 등 포함
        r"품목[\s·ㆍ\-]*허가[^)\n]*철회",
        r"자진[\s·ㆍ\-]*취하",
    ],
    "품목허가 신청": [
        r"품목[\s·ㆍ\-]*허가[^)\n]*신청",
        r"(?:품목[\s·ㆍ\-]*변경[\s·ㆍ\-]*허가|품목[\s·ㆍ\-]*변경허가)[^)\n]*신청",
        r"의약품[\s·ㆍ\-]*품목[\s·ㆍ\-]*허가[^)\n]*신청",
        r"(?:제조|제조판매)[\s·ㆍ\-]*품목[\s·ㆍ\-]*허가[^)\n]*신청",
    ],
    "품목허가 승인": [
        r"품목[\s·ㆍ\-]*허가[^)\n]*승인",
        r"품목[\s·ㆍ\-]*허가[^)\n]*완료",
        r"품목[\s·ㆍ\-]*허가[^)\n]*획득",
        r"품목[\s·ㆍ\-]*허가[^)\n]*취득",
        r"품목[\s·ㆍ\-]*허가[^)\n]*(?:승인[\s·ㆍ\-]*권고|승인권고)",
    ],
    # --- 기타 ---
    "횡령ㆍ배임혐의발생": [
        r"횡령[\s·ㆍ\-]*ㆍ?[\s·ㆍ\-]*배임[\s·ㆍ\-]*혐의[\s·ㆍ\-]*발생"
    ],
    "주식분할 결정": [
        r"(?:주식)?[\s·ㆍ\-]*분할[\s·ㆍ\-]*결정",
    ],
    "공개매수": ["공개매수신고서"],
}
